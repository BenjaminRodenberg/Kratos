import KratosMultiphysics
import math


class _ElementData:
    "Struct containing data mimicking CompressibleNavierStokesExplicit::ElementDataStruct."
    def __init__(self, dim, num_nodes):
        block_size = dim + 2

        self.U = self._ZeroMatrix(block_size, num_nodes)
        self.dUdt = self._ZeroMatrix(block_size, num_nodes)

        self.m_ext = self._ZeroVector(num_nodes)
        self.r_ext = self._ZeroVector(num_nodes)
        self.f_ext = self._ZeroMatrix(num_nodes, dim)

        self.alpha_sc_nodes = self._ZeroVector(num_nodes)
        self.beta_sc_nodes = self._ZeroVector(num_nodes)
        self.lamb_sc_nodes = self._ZeroVector(num_nodes)
        self.mu_sc_nodes = self._ZeroVector(num_nodes)
        self.alpha = 0.0
        self.beta = 0.0
        self.lambda_ = 0.0
        self.mu = 0.0
        self.h = 0.0
        self.gamma = 0.0
        self.c_v = 0.0
        self.ResProj = self._ZeroMatrix(num_nodes, block_size)

    @classmethod
    def _ZeroMatrix(cls, rows, cols):
        m = KratosMultiphysics.Matrix(rows, cols)
        for r in range(rows):
            for c in range(cols):
                m[r,c] = 0.0
        return m

    @classmethod
    def _ZeroVector(cls, rows):
        v = KratosMultiphysics.Vector(rows)
        for r in range(rows):
            v[r] = 0.0
        return v

class SubTestSuite:
    num_nodes = 4
    dim = 3
    block_size = dim + 2

    @classmethod
    def __ShapeFunctions(cls, x, y, z):
        N = KratosMultiphysics.Vector(cls.num_nodes)
        N[0] = -(1+x+y+z)/3
        N[1] = (1+x)/2
        N[2] = (1+y)/2
        N[3] = (1+z)/2

        DN_DX = KratosMultiphysics.Matrix(cls.num_nodes, cls.block_size)
        DN_DX[0,0] = -1/3.0
        DN_DX[0,1] = -1/3.0
        DN_DX[0,2] = -1/3.0
        DN_DX[1,0] =  0.5
        DN_DX[1,1] =  0
        DN_DX[1,2] = 0
        DN_DX[2,0] =  0
        DN_DX[2,1] =  0.5
        DN_DX[2,2] = 0
        DN_DX[3,0] =  0
        DN_DX[3,1] =  0
        DN_DX[3,2] = 0.5

        return N, DN_DX

    @classmethod
    def __FillVector(cls, rows, value):
        v = KratosMultiphysics.Vector(rows)
        for r in range(rows):
            v[r] = value
        return v

    def __init__(self):
        self.N, self.DN_DX = self.__ShapeFunctions(0, 0, 0)

        # Filling data
        rho_0 = 1.16927
        rho_1 = 1.46426

        mom = 467.707

        et_0 = 346854
        et_1 = 422234

        self.data = _ElementData(self.dim, self.num_nodes)

        self.data.U[0,0] = rho_0
        self.data.U[1,0] = rho_1
        self.data.U[2,0] = rho_0
        self.data.U[3,0] = rho_0

        self.data.U[0,1] = mom
        self.data.U[1,1] = mom
        self.data.U[2,1] = mom
        self.data.U[3,1] = mom

        self.data.U[0,4] = et_0
        self.data.U[1,4] = et_1
        self.data.U[2,4] = et_0
        self.data.U[3,4] = et_0

        self.data.alpha_sc_nodes = self.__FillVector(self.num_nodes, 1.5e-4)
        self.data.beta_sc_nodes = self.__FillVector(self.num_nodes, 2.8e-5)
        self.data.lamb_sc_nodes = self.__FillVector(self.num_nodes, 1.3e-7)
        self.data.mu_sc_nodes = self.__FillVector(self.num_nodes, 2.3e-6)

        self.data.alpha = 0
        self.data.beta = 1.13e-4
        self.data.lambda_ = 6.84e-6
        self.data.mu = 1.26e-4

        self.data.gamma = 1.4
        self.data.c_v = 722.14
        self.data.h = 2.0

    def test_substitute_rho_proj_3D(self):
        N = self.N
        DN_DX = self.DN_DX
        data = self.data

        rho_proj = KratosMultiphysics.Vector(self.num_nodes)

        #substitute_rho_proj_3D:
        //substitute_rho_proj_3D

        expected = KratosMultiphysics.Vector(self.num_nodes)
        expected[0] = -77.95116666666667
        expected[1] = -77.95116666666667
        expected[2] = -77.95116666666667
        expected[3] = -77.95116666666667

        return (rho_proj, expected)


    def test_substitute_mom_proj_3D(self):
        N = self.N
        DN_DX = self.DN_DX
        data = self.data

        mom_proj = KratosMultiphysics.Vector(self.dim * self.num_nodes)

        #substitute_mom_proj_3D:
        //substitute_mom_proj_3D

        expected = KratosMultiphysics.Vector(self.dim * self.num_nodes)
        expected[0]  = -38199.02672739978
        expected[1]  = -23123.790603943835
        expected[2]  = -23123.743318150053
        expected[3]  = -38199.37073395902
        expected[4]  = -23123.681303369005
        expected[5]  = -23123.657316510238
        expected[6]  = -38199.38895411392
        expected[7]  = -23123.675308142858
        expected[8]  = -23123.65276147152
        expected[9]  = -38199.370733959026
        expected[10] = -23123.681303369005
        expected[11] = -23123.657316510238

        return (mom_proj, expected)

    def test_substitute_tot_ener_proj_3D(self):
        N = self.N
        DN_DX = self.DN_DX
        data = self.data

        tot_ener_proj = KratosMultiphysics.Vector(self.num_nodes)

        #substitute_tot_ener_proj_3D:
        //substitute_tot_ener_proj_3D

        expected = KratosMultiphysics.Vector(self.num_nodes)
        expected[0] = 650.3440456366135
        expected[1] = 237.28688757874562
        expected[2] = 203.7025514637592
        expected[3] = 224.71439433220826

        return (tot_ener_proj, expected)


    def test_substitute_rhs_3D_OSS(self):
        N = self.N
        DN_DX = self.DN_DX
        data = self.data

        rRightHandSideBoundedVector = KratosMultiphysics.Vector(self.block_size*self.num_nodes)

        stab_c1 = 12
        stab_c2 = 2
        stab_c3 = 1

        #substitute_rhs_3D_OSS:
        //substitute_rhs_3D_OSS

        expected = KratosMultiphysics.Vector(self.block_size*self.num_nodes)
        expected[0]  = 129586.20119766363
        expected[1]  = -37873.97680550018
        expected[2]  = -23262.112022792877
        expected[3]  = -23254.902094387715
        expected[4]  = 413798.27815090655
        expected[5]  = -88081.72225294712
        expected[6]  = -38089.27176059989
        expected[7]  = -23214.188567774396
        expected[8]  = -23209.942729985993
        expected[9]  = -78249.92364793493
        expected[10] = -53318.556610606465
        expected[11] = -38189.82410562327
        expected[12] = -22809.305721861176
        expected[13] = -23116.55461027401
        expected[14] = -20008.098125665212
        expected[15] = -53329.80318294185
        expected[16] = -38182.965865428974
        expected[17] = -23120.398712731923
        expected[18] = -22804.74677521582
        expected[19] = -14319.600207868687

        return (rRightHandSideBoundedVector, expected)

    def test_substitute_rhs_3D_ASGS(self):
        N = self.N
        DN_DX = self.DN_DX
        data = self.data

        rRightHandSideBoundedVector = KratosMultiphysics.Vector(self.block_size*self.num_nodes)

        stab_c1 = 12
        stab_c2 = 2
        stab_c3 = 1

        #substitute_rhs_3D_ASGS:
        //substitute_rhs_3D_ASGS

        expected = KratosMultiphysics.Vector(self.block_size*self.num_nodes)
        expected[0]  = 129586.20119766363
        expected[1]  = -37873.97680550017
        expected[2]  = -23262.112022792873
        expected[3]  = -23254.90209438772
        expected[4]  = 413798.27815090655
        expected[5]  = -88081.72225294712
        expected[6]  = -38089.2717605999
        expected[7]  = -23214.1885677744
        expected[8]  = -23209.942729985996
        expected[9]  = -78249.92364793495
        expected[10] = -53318.556610606465
        expected[11] = -38189.82410562327
        expected[12] = -22809.305721861172
        expected[13] = -23116.55461027401
        expected[14] = -20008.0981256652
        expected[15] = -53329.80318294185
        expected[16] = -38182.965865428974
        expected[17] = -23120.39871273192
        expected[18] = -22804.74677521582
        expected[19] = -14319.600207868678

        return (rRightHandSideBoundedVector, expected)
